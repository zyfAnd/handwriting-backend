name: Sync Data to Cloudflare

on:
  push:
    branches:
      - main
    paths:
      - 'data-collection/collected_characters/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force full sync'
        required: false
        default: 'false'

jobs:
  sync-to-cloudflare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Check collected files
        id: check_files
        run: |
          cd data-collection/collected_characters
          PNG_COUNT=$(find . -name "*.png" -type f | wc -l)
          echo "png_count=$PNG_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š å‘ç° $PNG_COUNT ä¸ª PNG æ–‡ä»¶"

          if [ -f "char_url_mapping.json" ]; then
            CHAR_COUNT=$(cat char_url_mapping.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
            echo "char_count=$CHAR_COUNT" >> $GITHUB_OUTPUT
            echo "ğŸ“ å‘ç° $CHAR_COUNT ä¸ªå­—ç¬¦æ˜ å°„"
          else
            echo "char_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload images to R2
        if: steps.check_files.outputs.png_count > 0
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd data-collection/collected_characters

          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ° R2..."

          for file in *.png; do
            if [ -f "$file" ]; then
              echo "  ä¸Šä¼ : $file"
              wrangler r2 object put \
                handwriting-characters/chars/$file \
                --file=$file \
                --content-type=image/png
            fi
          done

          echo "âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ"

      - name: Upload mapping to KV
        if: steps.check_files.outputs.char_count > 0
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd data-collection/collected_characters

          if [ ! -f "char_url_mapping.json" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ° char_url_mapping.json"
            exit 0
          fi

          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ å­—ç¬¦æ˜ å°„åˆ° KV..."

          # è¯»å–æ˜ å°„æ–‡ä»¶å¹¶é€ä¸ªä¸Šä¼ åˆ° KV
          cat char_url_mapping.json | python3 -c "
import json
import sys
import subprocess

mapping = json.load(sys.stdin)
count = 0

for char, data in mapping.items():
    # æ„å»º KV å€¼
    kv_value = {
        'char': char,
        'filename': data.get('filename', ''),
        'unicode': data.get('unicode', ''),
        'url': f'https://handwriting-characters.r2.dev/chars/{data.get(\"filename\", \"\")}',
        'size': data.get('size', 0),
        'timestamp': data.get('timestamp', '')
    }

    # ä¸Šä¼ åˆ° KV
    key = char
    value = json.dumps(kv_value, ensure_ascii=False)

    cmd = [
        'wrangler', 'kv', 'key', 'put',
        key,
        value,
        '--namespace-id', '738e433e15b2438381d85d852029e791'
    ]

    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        count += 1
        print(f'  âœ… {char} -> {data.get(\"filename\", \"\")}')
    except subprocess.CalledProcessError as e:
        print(f'  âŒ ä¸Šä¼ å¤±è´¥: {char} - {e.stderr}')

print(f'\nâœ… å®Œæˆï¼å…±ä¸Šä¼  {count} ä¸ªå­—ç¬¦æ˜ å°„')
"

          echo "âœ… å­—ç¬¦æ˜ å°„ä¸Šä¼ å®Œæˆ"

      - name: Create summary
        run: |
          echo "## ğŸ“Š æ•°æ®åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ–¼ï¸ PNG æ–‡ä»¶: ${{ steps.check_files.outputs.png_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ å­—ç¬¦æ˜ å°„: ${{ steps.check_files.outputs.char_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° åŒæ­¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ è®¿é—® API" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Health: https://handwriting-api.zhangyanfu66.workers.dev/api/health" >> $GITHUB_STEP_SUMMARY
          echo "- Stats: https://handwriting-api.zhangyanfu66.workers.dev/api/stats" >> $GITHUB_STEP_SUMMARY
          echo "- Search: https://handwriting-api.zhangyanfu66.workers.dev/api/search?q=æ°´" >> $GITHUB_STEP_SUMMARY

      - name: Notify completion
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… æ•°æ®åŒæ­¥å®Œæˆ"
          echo "=========================================="
          echo "PNG æ–‡ä»¶: ${{ steps.check_files.outputs.png_count }}"
          echo "å­—ç¬¦æ˜ å°„: ${{ steps.check_files.outputs.char_count }}"
          echo "=========================================="
