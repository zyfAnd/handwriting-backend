# æ‰§è¡ŒæŒ‡å— - CloudBrush å­—ç¬¦æ‰¹é‡é‡‡é›†

## ğŸ¯ ç›®æ ‡

ä½¿ç”¨ä½ æä¾›çš„ Token æ‰¹é‡é‡‡é›† CloudBrush App ä¸­çš„å¸¸ç”¨æ±‰å­—å›¾ç‰‡ï¼ˆçº¦ 3500 ä¸ªï¼‰

## ğŸ“‹ å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥ï¼‰

### æ­¥éª¤ 1: è·å– Token

ä» Charles ä¸­è·å– CloudBrush App çš„ API Tokenï¼š

1. åœ¨ Charles ä¸­æ‰¾åˆ° `sfapi.fanglige.com` çš„è¯·æ±‚
2. æŸ¥çœ‹ Request Headers ä¸­çš„ `Authorization` å­—æ®µ
3. å¤åˆ¶ `Bearer` åé¢çš„å®Œæ•´ token

ç¤ºä¾‹ï¼š
```
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGci...ï¼ˆå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰
```

### æ­¥éª¤ 2: æµ‹è¯• Token

```bash
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# æµ‹è¯• token æ˜¯å¦æœ‰æ•ˆ
python3 test_token.py 'your_token_here'
```

å¦‚æœçœ‹åˆ° `âœ… Token æœ‰æ•ˆï¼å¯ä»¥å¼€å§‹æ‰¹é‡é‡‡é›†`ï¼Œè¯´æ˜ token å¯ç”¨ã€‚

### æ­¥éª¤ 3: æ‰¹é‡é‡‡é›†

```bash
# æ–¹å¼ 1: ä½¿ç”¨ run.shï¼ˆæ¨èï¼‰
./run.sh 'your_token_here'

# æ–¹å¼ 2: ä½¿ç”¨ Python ç›´æ¥è¿è¡Œ
export CLOUDBRUSH_TOKEN='your_token_here'
python3 api_collector.py
```

---

## ğŸ“– è¯¦ç»†æ­¥éª¤

### 1. å‡†å¤‡ç¯å¢ƒ

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# æ£€æŸ¥ Python ç‰ˆæœ¬ï¼ˆéœ€è¦ 3.6+ï¼‰
python3 --version

# å®‰è£…ä¾èµ–
pip3 install requests tqdm
```

### 2. ä» Charles è·å– Token

#### 2.1 å¯åŠ¨ Charles

- ç¡®ä¿ iPhone å·²é…ç½® Charles ä»£ç†
- å¯åŠ¨ Charles å¹¶å¼€å§‹å½•åˆ¶

#### 2.2 åœ¨ App ä¸­è§¦å‘è¯·æ±‚

1. æ‰“å¼€ CloudBrush App
2. éšä¾¿æŸ¥è¯¢ä¸€ä¸ªå­—ï¼ˆå¦‚"æ°´"ï¼‰
3. ç­‰å¾…ç»“æœæ˜¾ç¤º

#### 2.3 åœ¨ Charles ä¸­æŸ¥æ‰¾è¯·æ±‚

1. åœ¨ Charles çš„è¯·æ±‚åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼š
   ```
   sfapi.fanglige.com
     â””â”€â”€ class
         â””â”€â”€ action.php?api=queryDict
   ```

2. ç‚¹å‡»è¿™ä¸ªè¯·æ±‚

3. é€‰æ‹©å³ä¾§çš„ "Request" æ ‡ç­¾

4. é€‰æ‹© "Headers" å­æ ‡ç­¾

5. æ‰¾åˆ° `Authorization` å­—æ®µï¼š
   ```
   Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOi...
   ```

6. å¤åˆ¶ `Bearer` åé¢çš„æ•´ä¸ª tokenï¼ˆå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰

### 3. æµ‹è¯• Token æœ‰æ•ˆæ€§

```bash
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# æµ‹è¯• token
python3 test_token.py 'your_token_here'
```

**æˆåŠŸç¤ºä¾‹ï¼š**
```
======================================================================
  CloudBrush API Token æµ‹è¯•å·¥å…·
======================================================================

ğŸ“¡ API åœ°å€: https://sfapi.fanglige.com
ğŸ”‘ Token: eyJ0eXAiOiJKV1QiLCJ...

ğŸ§ª å¼€å§‹æµ‹è¯•...

æµ‹è¯•å­—ç¬¦: 'æ°´' ... âœ… æˆåŠŸï¼ˆJSONï¼Œ1234 charsï¼‰
   å“åº”å­—æ®µ: ['iv', 'value', 'mac', 'tag']
æµ‹è¯•å­—ç¬¦: 'ç«' ... âœ… æˆåŠŸï¼ˆJSONï¼Œ1234 charsï¼‰
   å“åº”å­—æ®µ: ['iv', 'value', 'mac', 'tag']
æµ‹è¯•å­—ç¬¦: 'æœ¨' ... âœ… æˆåŠŸï¼ˆJSONï¼Œ1234 charsï¼‰
   å“åº”å­—æ®µ: ['iv', 'value', 'mac', 'tag']
æµ‹è¯•å­—ç¬¦: 'é‡‘' ... âœ… æˆåŠŸï¼ˆJSONï¼Œ1234 charsï¼‰
   å“åº”å­—æ®µ: ['iv', 'value', 'mac', 'tag']
æµ‹è¯•å­—ç¬¦: 'åœŸ' ... âœ… æˆåŠŸï¼ˆJSONï¼Œ1234 charsï¼‰
   å“åº”å­—æ®µ: ['iv', 'value', 'mac', 'tag']

======================================================================
ğŸ“Š æµ‹è¯•ç»“æœ
======================================================================
   æµ‹è¯•å­—ç¬¦æ•°: 5
   æˆåŠŸ: 5
   å¤±è´¥: 0

âœ… Token æœ‰æ•ˆï¼å¯ä»¥å¼€å§‹æ‰¹é‡é‡‡é›†

æ‰§è¡Œé‡‡é›†:
  export CLOUDBRUSH_TOKEN='your_token_here'
  python3 api_collector.py
```

**å¤±è´¥ç¤ºä¾‹ï¼š**
```
æµ‹è¯•å­—ç¬¦: 'æ°´' ... âŒ è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰- Token å¯èƒ½æ— æ•ˆæˆ–è¿‡æœŸ

======================================================================
ğŸ“Š æµ‹è¯•ç»“æœ
======================================================================
   æµ‹è¯•å­—ç¬¦æ•°: 5
   æˆåŠŸ: 0
   å¤±è´¥: 5

âŒ Token æ— æ•ˆæˆ– API é…ç½®é”™è¯¯

å¯èƒ½çš„åŸå› :
  1. Token å·²è¿‡æœŸ - éœ€è¦é‡æ–°ä» Charles è·å–
  2. Token æ ¼å¼ä¸æ­£ç¡® - æ£€æŸ¥æ˜¯å¦å®Œæ•´å¤åˆ¶
  3. API åœ°å€é”™è¯¯ - æ£€æŸ¥ API_BASE_URL
  4. Token Header æ ¼å¼ä¸å¯¹ - å¯èƒ½éœ€è¦è°ƒæ•´
```

### 4. å¼€å§‹æ‰¹é‡é‡‡é›†

#### æ–¹å¼ 1: ä½¿ç”¨ run.sh è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä¸€é”®è¿è¡Œ
./run.sh 'your_token_here'
```

#### æ–¹å¼ 2: ä½¿ç”¨ Python è„šæœ¬

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export CLOUDBRUSH_TOKEN='your_token_here'

# è¿è¡Œé‡‡é›†è„šæœ¬
python3 api_collector.py
```

#### æ–¹å¼ 3: äº¤äº’å¼è¾“å…¥

```bash
# ç›´æ¥è¿è¡Œï¼Œä¼šæç¤ºè¾“å…¥ token
python3 api_collector.py

# ç„¶åè¾“å…¥ token
è¯·è¾“å…¥ API Token: <ç²˜è´´ä½ çš„token>
```

### 5. é‡‡é›†è¿‡ç¨‹

é‡‡é›†è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºï¼š

```
======================================================================
CloudBrush API ç›´æ¥é‡‡é›†å™¨
======================================================================

ğŸ“¡ API åœ°å€: https://sfapi.fanglige.com
ğŸ”‘ Token Header: Authorization
ğŸ“ Token æ ¼å¼: Bearer {token}

ğŸ“‚ å·²åŠ è½½ 0 ä¸ªå·²é‡‡é›†å­—ç¬¦

ğŸ§ª æµ‹è¯•è¿æ¥...
âœ… æµ‹è¯•æˆåŠŸï¼å¯ä»¥è·å– 'æ°´' çš„å›¾ç‰‡
   å›¾ç‰‡å¤§å°: 12345 bytes

ğŸš€ å¼€å§‹æ‰¹é‡é‡‡é›† 3500 ä¸ªæ±‰å­—...
   å·²é‡‡é›†: 0
   å¾…é‡‡é›†: 3500

é‡‡é›†è¿›åº¦:   0%|                              | 0/3500 [00:00<?, ?it/s]
âœ… [1] ä¿å­˜: 'çš„' -> 7684_çš„.png (12345 bytes)
é‡‡é›†è¿›åº¦:   1%|â–                     | 1/3500 [00:00<30:00, 1.94it/s]
âœ… [2] ä¿å­˜: 'ä¸€' -> 4e00_ä¸€.png (8765 bytes)
...

======================================================================
ğŸ“Š é‡‡é›†è¿›åº¦: 3500/3500 (100.0%)
   å›¾ç‰‡æ€»æ•°: 3500
   å¤±è´¥: 0
======================================================================

======================================================================
ğŸ‰ é‡‡é›†å®Œæˆï¼
======================================================================
   å¸¸ç”¨å­—æ€»æ•°: 3500
   å·²é‡‡é›†å­—ç¬¦: 3500
   å®Œæˆç‡: 100.0%
   å›¾ç‰‡æ€»æ•°: 3500
   å¤±è´¥: 0
   ä¿å­˜ä½ç½®: ./collected_characters
   æ˜ å°„æ–‡ä»¶: ./collected_characters/char_url_mapping.json
   æŠ¥å‘Šæ–‡ä»¶: ./collected_characters/collection_report.json
======================================================================
```

### 6. æŸ¥çœ‹ç»“æœ

```bash
# æŸ¥çœ‹é‡‡é›†çš„å›¾ç‰‡æ•°é‡
ls collected_characters/*.png | wc -l

# æŸ¥çœ‹æ˜ å°„æ–‡ä»¶
cat collected_characters/char_url_mapping.json | head -20

# æŸ¥çœ‹é‡‡é›†æŠ¥å‘Š
cat collected_characters/collection_report.json
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

```bash
# Tokenï¼ˆå¿…éœ€ï¼‰
export CLOUDBRUSH_TOKEN='your_token_here'

# API åœ°å€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šhttps://sfapi.fanglige.comï¼‰
export CLOUDBRUSH_API_URL='https://sfapi.fanglige.com'

# Token Header åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šAuthorizationï¼‰
export CLOUDBRUSH_TOKEN_HEADER='Authorization'

# Token æ ¼å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šBearer {token}ï¼‰
export CLOUDBRUSH_TOKEN_FORMAT='Bearer {token}'
```

### è°ƒæ•´è¯·æ±‚å»¶è¿Ÿ

å¦‚æœé‡åˆ°é™æµæˆ–è¯·æ±‚å¤±è´¥ï¼Œå¯ä»¥è°ƒæ•´å»¶è¿Ÿï¼š

ç¼–è¾‘ `api_collector.py` çš„æœ€åéƒ¨åˆ†ï¼š

```python
# æ‰¾åˆ°è¿™ä¸€è¡Œï¼ˆç¬¬ 449 è¡Œå·¦å³ï¼‰
collector.collect_batch(delay=0.5)  # é»˜è®¤ 0.5 ç§’

# æ”¹ä¸ºï¼š
collector.collect_batch(delay=1.0)  # 1 ç§’å»¶è¿Ÿï¼ˆæ›´å®‰å…¨ï¼‰
# æˆ–
collector.collect_batch(delay=0.2)  # 0.2 ç§’å»¶è¿Ÿï¼ˆæ›´å¿«ï¼Œä½†å¯èƒ½è¢«é™æµï¼‰
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Token æµ‹è¯•å¤±è´¥

**ç°è±¡**ï¼š`âŒ è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰- Token å¯èƒ½æ— æ•ˆæˆ–è¿‡æœŸ`

**è§£å†³**ï¼š
1. æ£€æŸ¥ token æ˜¯å¦å®Œæ•´å¤åˆ¶ï¼ˆåŒ…æ‹¬æœ€åçš„éƒ¨åˆ†ï¼‰
2. ç¡®è®¤ token å‰é¢æ²¡æœ‰ `Bearer ` å­—æ ·ï¼ˆåªè¦ token æœ¬èº«ï¼‰
3. é‡æ–°åœ¨ App ä¸­æ“ä½œï¼Œä» Charles è·å–æœ€æ–°çš„ token

### é—®é¢˜ 2: è¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥

**ç°è±¡**ï¼š`âŒ è¯·æ±‚è¶…æ—¶` æˆ– `âŒ è¿æ¥å¤±è´¥`

**è§£å†³**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. ç¡®è®¤ API åœ°å€æ­£ç¡®
3. å¢åŠ è¯·æ±‚å»¶è¿Ÿï¼ˆä¿®æ”¹ `delay` å‚æ•°ï¼‰

### é—®é¢˜ 3: éƒ¨åˆ†å­—ç¬¦é‡‡é›†å¤±è´¥

**ç°è±¡**ï¼šå®Œæˆç‡ä¸æ˜¯ 100%

**è§£å†³**ï¼š
1. æŸ¥çœ‹ `collection_report.json` ä¸­çš„ `missing_chars`
2. å†æ¬¡è¿è¡Œè„šæœ¬ï¼ˆä¼šè‡ªåŠ¨è·³è¿‡å·²é‡‡é›†çš„ï¼Œåªé‡‡é›†å¤±è´¥çš„ï¼‰
3. å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯èƒ½è¿™äº›å­—ç¬¦åœ¨ API ä¸­ä¸å­˜åœ¨

### é—®é¢˜ 4: ä¾èµ–å®‰è£…å¤±è´¥

**ç°è±¡**ï¼š`ModuleNotFoundError: No module named 'requests'`

**è§£å†³**ï¼š
```bash
# ä½¿ç”¨ pip3 å®‰è£…
pip3 install requests tqdm

# å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ï¼š
python3 -m pip install requests tqdm
```

### é—®é¢˜ 5: é‡‡é›†ä¸­æ–­

**ç°è±¡**ï¼šæŒ‰ Ctrl+C ä¸­æ–­æˆ–ç¨‹åºå´©æºƒ

**è§£å†³**ï¼š
```bash
# ç›´æ¥å†æ¬¡è¿è¡Œï¼Œä¼šä»ä¸­æ–­å¤„ç»§ç»­
python3 api_collector.py
```

è„šæœ¬ä¼šè‡ªåŠ¨åŠ è½½ `collected_characters/char_url_mapping.json`ï¼Œè·³è¿‡å·²é‡‡é›†çš„å­—ç¬¦ã€‚

---

## ğŸ“Š æ€§èƒ½å‚è€ƒ

- **å­—ç¬¦æ•°é‡**: çº¦ 3500 ä¸ª
- **è¯·æ±‚å»¶è¿Ÿ**: 0.5 ç§’/æ¬¡
- **é¢„è®¡æ—¶é—´**: çº¦ 30 åˆ†é’Ÿ
- **æ–‡ä»¶å¤§å°**: çº¦ 50-100 MB
- **æˆåŠŸç‡**: é€šå¸¸ > 95%

---

## ğŸ‰ é‡‡é›†å®Œæˆå

é‡‡é›†å®Œæˆåï¼Œä½ ä¼šå¾—åˆ°ï¼š

1. **å›¾ç‰‡æ–‡ä»¶** - `collected_characters/*.png`
2. **æ˜ å°„æ–‡ä»¶** - `collected_characters/char_url_mapping.json`
3. **é‡‡é›†æŠ¥å‘Š** - `collected_characters/collection_report.json`

### ä¸‹ä¸€æ­¥ï¼š

1. **éªŒè¯æ•°æ®**
   ```bash
   # æŸ¥çœ‹é‡‡é›†æ•°é‡
   ls collected_characters/*.png | wc -l

   # éšæœºæŸ¥çœ‹å‡ ä¸ªå›¾ç‰‡
   open collected_characters/6c34_æ°´.png
   ```

2. **ä¸Šä¼ åˆ°äº‘å­˜å‚¨**ï¼ˆå¦‚éœ€è¦ï¼‰
   - ä¸Šä¼ å›¾ç‰‡åˆ° Cloudflare R2 / AWS S3
   - æ›´æ–°æ•°æ®åº“ä¸­çš„å›¾ç‰‡ URL

3. **æ„å»º API**
   - ä½¿ç”¨é‡‡é›†çš„æ•°æ®æ„å»ºå­—å…¸ API
   - æä¾›å‰ç«¯è°ƒç”¨

---

**ç°åœ¨ä½ å¯ä»¥å¼€å§‹æ‰§è¡Œäº†ï¼**

```bash
# 1. æµ‹è¯• token
python3 test_token.py 'your_token_here'

# 2. å¦‚æœæµ‹è¯•æˆåŠŸï¼Œå¼€å§‹é‡‡é›†
./run.sh 'your_token_here'
```

æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ [`ä½¿ç”¨æŒ‡å—.md`](./ä½¿ç”¨æŒ‡å—.md)
