# CloudBrush 字符批量采集工具 - 使用指南

## 🎯 目标

批量采集 CloudBrush App 中的常用汉字图片（约 3500 个）

## 📋 准备工作

### 1. 获取 Token

使用 Charles 抓包获取 CloudBrush App 的 API Token：

1. **启动 Charles**
   - 确保 iPhone 已配置 Charles 代理
   - 启动 Charles 并开始录制

2. **打开 CloudBrush App**
   - 随便查询一个字（如"水"）

3. **在 Charles 中找到请求**
   - 找到类似 `sfapi.fanglige.com/class/action.php?api=queryDict` 的请求
   - 点击查看请求详情

4. **复制 Token**
   - 在 Request Headers 中找到 `Authorization` 字段
   - 复制完整的 token 值（通常是 `Bearer` 后面的内容）

   示例：
   ```
   Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczpcL1wvc2ZhcGkuZmFuZ2xpZ2UuY29tXC91c2VyXC9sb2dpbiIsImlhdCI6MTczMTc0MDQ0NCwiZXhwIjoxNzM0MzMyNDQ0LCJuYmYiOjE3MzE3NDA0NDQsImp0aSI6IlhYWFhYWCIsInN1YiI6IjEyMzQ1Njc4IiwicHJ2IjoiMjNiZDVjODk0OWY2MDBhZGIzOWU3MDFjNDAwODcyZGI3YTU5NzZmNyJ9.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
   ```

   你需要复制的是：
   ```
   eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczpcL1wvc2ZhcGkuZmFuZ2xpZ2UuY29tXC91c2VyXC9sb2dpbiIsImlhdCI6MTczMTc0MDQ0NCwiZXhwIjoxNzM0MzMyNDQ0LCJuYmYiOjE3MzE3NDA0NDQsImp0aSI6IlhYWFhYWCIsInN1YiI6IjEyMzQ1Njc4IiwicHJ2IjoiMjNiZDVjODk0OWY2MDBhZGIzOWU3MDFjNDAwODcyZGI3YTU5NzZmNyJ9.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
   ```

### 2. 安装依赖

```bash
# 安装 Python 依赖
pip3 install requests tqdm
```

## 🚀 开始采集

### 方式 1: 使用 run.sh 脚本（推荐）

```bash
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# 直接传入 token
./run.sh 'your_token_here'
```

### 方式 2: 使用环境变量

```bash
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# 设置环境变量
export CLOUDBRUSH_TOKEN='your_token_here'

# 运行脚本
python3 api_collector.py
```

### 方式 3: 交互式输入

```bash
cd /Volumes/thinkplus-1T/my-github/handwriting-backend/data-collection

# 运行脚本，会提示输入 token
python3 api_collector.py
```

## 📊 执行流程

运行脚本后，你会看到：

```
======================================================================
CloudBrush API 直接采集器
======================================================================

📡 API 地址: https://sfapi.fanglige.com
🔑 Token Header: Authorization
📝 Token 格式: Bearer {token}

📂 已加载 XXX 个已采集字符

🧪 测试连接...
✅ 测试成功！可以获取 '水' 的图片
   图片大小: 12345 bytes

🚀 开始批量采集...

🚀 开始批量采集 3500 个汉字...
   已采集: 0
   待采集: 3500

采集进度: 100%|██████████████████████████| 3500/3500 [30:00<00:00, 1.94it/s]

======================================================================
📊 采集进度: 3500/3500 (100.0%)
   图片总数: 3500
   失败: 0
======================================================================

======================================================================
🎉 采集完成！
======================================================================
   常用字总数: 3500
   已采集字符: 3500
   完成率: 100.0%
   图片总数: 3500
   失败: 0
   保存位置: ./collected_characters
   映射文件: ./collected_characters/char_url_mapping.json
   报告文件: ./collected_characters/collection_report.json
======================================================================
```

## 📁 采集结果

采集完成后，文件会保存在 `collected_characters/` 目录下：

```
collected_characters/
├── 6c34_水.png                 # 图片文件（格式：unicode_汉字.png）
├── 4e00_一.png
├── 662f_是.png
├── ...
├── char_url_mapping.json       # 字符到 URL 的映射
└── collection_report.json      # 采集报告
```

### char_url_mapping.json 示例

```json
{
  "水": {
    "url": "https://sfapi.fanglige.com/svg_png/xxx.png",
    "filename": "6c34_水.png",
    "unicode": "U+6C34",
    "size": 12345,
    "timestamp": "2024-11-16T16:30:00"
  },
  "一": {
    "url": "https://sfapi.fanglige.com/svg_png/xxx.png",
    "filename": "4e00_一.png",
    "unicode": "U+4E00",
    "size": 8765,
    "timestamp": "2024-11-16T16:30:01"
  }
}
```

### collection_report.json 示例

```json
{
  "summary": {
    "total_chars": 3500,
    "collected_chars": 3500,
    "images_saved": 3500,
    "failed": 0,
    "completion_rate": "100.0%"
  },
  "missing_chars": [],
  "stats": {
    "total_requests": 3500,
    "images_saved": 3500,
    "api_responses": 3500,
    "failed": 0,
    "start_time": "2024-11-16T16:00:00"
  }
}
```

## ⚙️ 配置选项

你可以通过环境变量自定义配置：

```bash
# API 基础 URL（默认：https://sfapi.fanglige.com）
export CLOUDBRUSH_API_URL='https://sfapi.fanglige.com'

# Token Header 名称（默认：Authorization）
export CLOUDBRUSH_TOKEN_HEADER='Authorization'

# Token 格式（默认：Bearer {token}）
export CLOUDBRUSH_TOKEN_FORMAT='Bearer {token}'

# Token 值（必需）
export CLOUDBRUSH_TOKEN='your_token_here'
```

## 🔧 高级功能

### 1. 采集特定字符

修改 `common_3500_chars.txt` 文件，只保留你想要采集的字符：

```bash
# 编辑字符列表
nano common_3500_chars.txt

# 运行采集
python3 api_collector.py
```

### 2. 调整请求延迟

在 `api_collector.py` 的 `main()` 函数中修改：

```python
# 默认延迟 0.5 秒
collector.collect_batch(delay=0.5)

# 改为 1 秒（避免请求过快）
collector.collect_batch(delay=1.0)

# 改为 0.2 秒（加快速度，但可能被限流）
collector.collect_batch(delay=0.2)
```

### 3. 断点续传

脚本支持断点续传，如果中途中断：

```bash
# 直接再次运行，会跳过已采集的字符
python3 api_collector.py
```

已采集的字符信息保存在 `collected_characters/char_url_mapping.json`

## ⚠️ 常见问题

### 1. Token 无效或过期

**现象**：测试连接失败

**解决**：
1. 重新从 Charles 获取最新的 token
2. 确保复制的 token 完整，没有多余空格
3. 检查 token 格式是否正确（Bearer 后面的部分）

### 2. 请求失败或超时

**现象**：大量请求失败

**解决**：
1. 检查网络连接
2. 增加请求延迟（修改 `delay` 参数）
3. 检查 API URL 是否正确

### 3. 部分字符采集失败

**现象**：完成率不是 100%

**解决**：
1. 查看 `collection_report.json` 中的 `missing_chars` 字段
2. 再次运行脚本，只会采集失败的字符
3. 或者手动在 App 中查询这些字符

### 4. 图片质量问题

**现象**：保存的图片不清晰

**解决**：
1. 检查 API 返回的图片 URL 是否是高清版本
2. 可能需要调整 API 参数（在 `api_collector.py` 中修改）

## 📝 数据使用

采集完成后，你可以：

1. **直接使用图片**
   ```bash
   ls collected_characters/*.png
   ```

2. **导入到数据库**
   - 使用 `char_url_mapping.json` 作为元数据
   - 图片文件名格式：`{unicode}_{汉字}.png`

3. **上传到云存储**
   - 批量上传图片到 OSS/R2
   - 更新数据库中的图片 URL

## 📊 性能估算

- **字符数量**: 约 3500 个
- **请求延迟**: 0.5 秒/次
- **预计时间**: 约 30 分钟
- **文件大小**: 约 50-100 MB（取决于图片质量）

## 🎉 下一步

采集完成后，可以：

1. 将图片上传到 Cloudflare R2 或其他云存储
2. 生成字体文件
3. 构建字典 API
4. 开发前端展示页面

---

**祝采集顺利！如有问题，请查看代码注释或联系开发者。**
